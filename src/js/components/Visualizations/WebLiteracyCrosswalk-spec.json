{
  "$schema": "https://vega.github.io/schema/vega/v3.json",
  "width": 650,
  "height": 650,
  "padding": 100,

  "data": [
    {
      "name": "data",
      "values": [],
      "transform": [
        {
          "type": "stack",
          "groupby": [
            "label"
          ],
          "field": "size",
          "sort": {
            "field": ["category","subcategory"],
            "order": ["descending","ascending"]
          },
          "as": [
            "r0",
            "r1"
          ]
        }
      ]
    },
    {
      "name": "summary",
      "source": "data",
      "transform": [{
      "type": "aggregate",
      "groupby": ["label"]
      },
      {
        "type": "pie",
        "field": "count",
        "startAngle": {
          "signal": "0"
        },
        "endAngle": {
          "signal": "-4.1"
        },
        "sort": true
      } ,
      {"type": "formula", "as": "midAngle", "expr": "(datum.startAngle + datum.endAngle)/2"},
      {"type": "formula", "as": "baseline", "expr": "datum.midAngle >(-PI/2)? 'bottom':'top' "},
      {"type": "formula", "as": "align", "expr": "datum.midAngle >(-PI) ? 'right':'left'"}
      ]
    },
    {
      "name": "summaryCat",
      "source": "data",
      "transform": [{
      "type": "aggregate",
      "groupby": ["subcategory", "category"],
      "fields": ["r0", "r1"],
      "ops": ["min", "max"],
      "as": ["r0", "r1"]
      },
      {"type": "formula", "as": "rm", "expr": "((datum.r1-datum.r0)/2) + datum.r0 + 5.8"}
      ]
    },
    {
      "name": "sumCat",
      "source": "summaryCat",
      "transform": [{
      "type": "aggregate",
      "groupby": ["category"],
      "fields": ["rm", "r0","r1"],
      "ops": ["max", "min", "max"],
      "as": ["rm","r0", "r1"]
      },
      {"type": "formula", "as": "r0", "expr": " datum.r0 + 5.8"},
      {"type": "formula", "as": "r1", "expr": " datum.r1 + 5.8"}]
      }

  ],
  "scales": [
    {
      "name": "r",
      "type": "linear",
      "domain": {
        "data": "data",
        "field": "r1"
      },
      "range": [
        {
          "signal": "width/2 - width/2.8"
        },
        {
          "signal": "width/2"
        }
      ]
    },
    {
      "name": "r-inverted",
      "type": "linear",
      "domain": {
        "data": "data",
        "field": "r1"
      },
      "range": [
        {
          "signal": "width/2"
        },
        {
          "signal": "width/2 - width/2.8"
        }
      ]
    },
    {
      "name": "color",
      "type": "ordinal",
      "range": ["#6DD8AF","#000000","#6DD8AF"]
    }
  ],

  "marks": [
    {
      "name": "pies",
      "type": "group",
      "from": {
        "facet": {
          "name": "facet",
          "data": "data",
          "groupby": "subcategory"
        }
      },
      "data": [
        {
          "name": "MyData",
          "source": "facet",
          "transform": [
            {
              "type": "pie",
              "field": "size",
              "startAngle": {
                "signal": "0"
              },
              "endAngle": {
                "signal": "-4.1"
              },
              "sort": true
            }
          ]
        }
      ],
      "marks": [
        {
          "name": "MyArc",
          "type": "arc",
          "from": {
            "data": "MyData"
          },
          "encode": {
            "enter": {
              "fill": [
                {
                  "test": "datum.value==1",
                  "scale": "color",
                "field": "category"
                },
                {
                  "value": "transparent"
                }
              ],
              "stroke": {
                "scale": "color",
                "field": "category"
              },
              "strokeWidth": {
                "value":0.15
              },
              "x": {
                "signal": "width / 2"
              },
              "y": {
                "signal": "height / 2"
              }
            },
            "update": {
              "opacity":{
                "value":1
              },
              "startAngle": {
                "field": "startAngle"
              },
              "endAngle": {
                "field": "endAngle"
              },
              "padAngle": {
                "value": 0.038
              },
              "innerRadius": {
                "scale": "r",
                "field": "r0",
                "offset": 7
              },
              "outerRadius": {
                "scale": "r",
                "field": "r1"
              },
              "cornerRadius": {
                "value": 0
              }
            },
            "hover": {
              "opacity":{
                "value":0.8
              }
            }
          }
        }
      ]
    },
      { "name":"labels",
      "interactive": false,
        "type": "text",
        "from": {
          "data": "summary"
        },
        "encode": {
          "enter": {
            "x": {
              "field": {
                "group": "width"
              },
              "mult": 0.5
            },
            "y": {
              "field": {
                "group": "height"
              },
              "mult": 0.5
            },
            "radius": {
              "signal": "width / 2",
              "offset": 8
            },
            "theta": {
              "signal": "(datum.startAngle + datum.endAngle)/2"
            },
            "align": {
              "field": "align"
            },
            "baseline": {
              "field": "baseline"
            },
            "text": {
              "field": "label"
            }
          }
        }
      },
    { "name":"skills",
    "interactive": false,
        "type": "text",
        "from": {
          "data": "summaryCat"
        },
        "encode": {
          "enter": {
            "x": {"signal": "width/2 + 7"},
          "y": {"scale": "r-inverted", "field":"rm"},
            "fill": {
              "value": "#000"
            },
            "align": {
              "value": "left"
            },
            "baseline": {
              "value": "middle"
            },
            "text": {
              "field": "subcategory"
            }
          }
        }
      },
      {
          "name": "legend",
           "interactive": false,
          "from": {"data": "sumCat"},
          "type": "rect",
          "encode": {
            "enter": {
                "x": {"signal": "2*width/2.95"},
          "y": {"scale": "r-inverted", "field":"r0", "offset":-5},
              "width": {"value":10},
              "y2": {"scale": "r-inverted", "field":"r1"},
              "fill": {"scale": "color", "field": "category"}
            }
          }
        },
      { "name":"cat",
    "interactive": false,
        "type": "text",
        "from": {
          "data": "sumCat"
        },
        "encode": {
          "enter": {
            "x": {"signal": "2*width/2.8"},
          "y": {"scale": "r-inverted", "field":"rm"},
            "fill": {
              "value": "#000"
            },
            "align": {
              "value": "left"
            },
            "baseline": {
              "value": "middle"
            },
            "text": {
              "field": "category"
            }
          }
        }
      }
  ]
}
